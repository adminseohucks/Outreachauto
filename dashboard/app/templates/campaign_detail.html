{% extends "base.html" %}
{% block title %}{{ campaign.name }} — LinkedPilot v2{% endblock %}

{% block content %}
<hgroup>
    <h2>{{ campaign.name }} <span class="badge badge-{{ campaign.status }}">{{ campaign.status }}</span></h2>
    <p>{{ campaign.campaign_type | capitalize }} campaign on list "{{ campaign.list_name or '—' }}" via {{ campaign.sender_name or '—' }}</p>
</hgroup>

<!-- Stats -->
<div class="stat-grid">
    <div class="stat-card blue">
        <span class="stat-value">{{ campaign.total_leads }}</span>
        <span class="stat-label">Total Leads</span>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ campaign.processed }}</span>
        <span class="stat-label">Processed</span>
    </div>
    <div class="stat-card green">
        <span class="stat-value">{{ campaign.successful }}</span>
        <span class="stat-label">Successful</span>
    </div>
    <div class="stat-card red">
        <span class="stat-value">{{ campaign.failed }}</span>
        <span class="stat-label">Failed</span>
    </div>
    <div class="stat-card orange">
        <span class="stat-value">{{ campaign.skipped }}</span>
        <span class="stat-label">Skipped</span>
    </div>
</div>

<!-- Queue status summary -->
{% if status_counts %}
<div style="margin-bottom: 1rem;">
    <small>
        Queue:
        <span class="badge badge-pending">{{ status_counts.get('pending', 0) }} pending</span>
        <span class="badge badge-running">{{ status_counts.get('running', 0) }} running</span>
        <span class="badge badge-done">{{ status_counts.get('done', 0) }} done</span>
        <span class="badge badge-failed">{{ status_counts.get('failed', 0) }} failed</span>
        <span class="badge badge-skipped">{{ status_counts.get('skipped', 0) }} skipped</span>
    </small>
</div>
{% endif %}

<!-- Progress bar -->
{% set pct = ((campaign.processed / campaign.total_leads * 100) | round(0) | int) if campaign.total_leads > 0 else 0 %}
<div class="progress-bar" style="height: 12px; margin-bottom: 1rem;">
    <div class="progress-fill green" style="width: {{ pct }}%"></div>
</div>
<p><small>{{ pct }}% complete &mdash; {{ campaign.processed }}/{{ campaign.total_leads }} leads processed</small></p>

<!-- Action buttons -->
<div class="action-buttons" style="margin-bottom: 1.5rem;">
    {% if campaign.status == 'draft' %}
    <form method="post" action="/campaigns/{{ campaign.id }}/start">
        <button type="submit">Start Campaign</button>
    </form>
    {% elif campaign.status == 'active' %}
    <form method="post" action="/campaigns/{{ campaign.id }}/pause">
        <button type="submit" class="secondary">Pause Campaign</button>
    </form>
    {% elif campaign.status == 'paused' %}
    <form method="post" action="/campaigns/{{ campaign.id }}/start" style="display:inline;">
        <button type="submit">Resume Campaign</button>
    </form>
    <form method="post" action="/campaigns/{{ campaign.id }}/cancel" onsubmit="return confirm('Cancel this campaign? Remaining actions will be skipped.')" style="display:inline;">
        <button type="submit" class="secondary">Cancel Campaign</button>
    </form>
    {% endif %}
    <a href="/campaigns" role="button" class="outline secondary">Back to Campaigns</a>
</div>

<!-- Action queue table — last 10 -->
<h3>Recent Actions <small style="color: var(--lp-gray);">(last 10)</small></h3>
{% if actions %}
<figure>
    <table class="data-table" role="grid">
        <thead>
            <tr>
                <th>Lead Name</th>
                <th>Profile URL</th>
                <th>Action</th>
                <th>Status</th>
                <th>Note / Comment</th>
                <th>Completed At</th>
                <th>Error</th>
            </tr>
        </thead>
        <tbody>
            {% for a in actions %}
            <tr>
                <td>{{ a.lead_name or '—' }}</td>
                <td>
                    {% if a.lead_url %}
                    <a href="{{ a.lead_url }}" target="_blank" rel="noopener">Profile</a>
                    {% else %}
                    —
                    {% endif %}
                </td>
                <td><span class="badge badge-{{ 'blue' if a.action_type == 'like' else 'green' if a.action_type == 'connect' else 'orange' }}">{{ a.action_type }}</span></td>
                <td><span class="badge badge-{{ a.status }}">{{ a.status }}</span></td>
                <td><small>{{ a.connect_note or a.comment_text or '—' }}</small></td>
                <td><small>{{ a.completed_at or '—' }}</small></td>
                <td><small>{{ a.error_message or '—' }}</small></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</figure>
{% else %}
<article>
    <p>No actions in the queue yet.</p>
</article>
{% endif %}
{% endblock %}
