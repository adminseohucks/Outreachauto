{% extends "base.html" %}
{% block title %}LinkedIn Search — LinkedPilot v2{% endblock %}

{% block content %}
<section>
    <hgroup>
        <h2>LinkedIn Search</h2>
        <p>Search LinkedIn for people using Voyager API. Add results to lists for campaigns.</p>
    </hgroup>

    <!-- Search Form -->
    <form method="post" action="/search/run" id="search-form">
        <div class="grid">
            <label>Search Keywords <small>(required)</small>
                <input type="text" name="keywords" placeholder="e.g. Software Engineer, CEO Fintech, Product Manager" value="{{ search_query or '' }}" required>
            </label>
            <label>Location <small>(optional — type to search)</small>
                <div style="position: relative;">
                    <input type="text" id="location-input" autocomplete="off"
                           placeholder="Type city or country..." value="{{ search_location or '' }}"
                           oninput="geoLookup(this.value)" onfocus="geoLookup(this.value)">
                    <input type="hidden" name="location" id="location-text" value="{{ search_location or '' }}">
                    <input type="hidden" name="geo_urn" id="geo-urn-input" value="">
                    <div id="geo-dropdown" style="display:none; position:absolute; top:100%; left:0; right:0; z-index:50; background:var(--pico-card-background-color); border:1px solid var(--pico-muted-border-color); border-radius:0 0 8px 8px; max-height:240px; overflow-y:auto; box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
            </label>
        </div>

        <div class="grid">
            <label>Search Using Account
                <select name="sender_id" required>
                    <option value="">-- Select sender --</option>
                    {% for s in senders %}
                    <option value="{{ s.id }}" {% if not s.browser_open %}disabled{% endif %}>
                        {{ s.name }} {% if s.browser_open %}(Online){% else %}(Browser closed){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </label>
            <label>Max Results
                <select name="max_results">
                    <option value="50">50</option>
                    <option value="100" selected>100</option>
                    <option value="250">250</option>
                    <option value="500">500</option>
                    <option value="999">999</option>
                </select>
            </label>
            <label>Network
                <select name="network">
                    <option value="" {% if not search_network %}selected{% endif %}>All Connections</option>
                    <option value="F" {% if search_network == 'F' %}selected{% endif %}>1st Degree</option>
                    <option value="S" {% if search_network == 'S' %}selected{% endif %}>2nd Degree</option>
                    <option value="O" {% if search_network == 'O' %}selected{% endif %}>3rd+ Degree</option>
                </select>
            </label>
            <label>Company Size
                <select name="company_size">
                    <option value="" {% if not search_company_size %}selected{% endif %}>Any Size</option>
                    <option value="B" {% if search_company_size == 'B' %}selected{% endif %}>1-10 employees</option>
                    <option value="C" {% if search_company_size == 'C' %}selected{% endif %}>11-50 employees</option>
                    <option value="D" {% if search_company_size == 'D' %}selected{% endif %}>51-200 employees</option>
                    <option value="E" {% if search_company_size == 'E' %}selected{% endif %}>201-500 employees</option>
                    <option value="F" {% if search_company_size == 'F' %}selected{% endif %}>501-1,000 employees</option>
                    <option value="G" {% if search_company_size == 'G' %}selected{% endif %}>1,001-5,000 employees</option>
                    <option value="H" {% if search_company_size == 'H' %}selected{% endif %}>5,001-10,000 employees</option>
                    <option value="I" {% if search_company_size == 'I' %}selected{% endif %}>10,001+ employees</option>
                </select>
            </label>
        </div>

        <button type="submit" id="search-btn">Search LinkedIn</button>
    </form>

    {% if error is defined and error %}
    <article style="background: #fef2f2; border-left: 4px solid #e53e3e; padding: 1rem; margin: 1rem 0;">
        <strong>Error:</strong> {{ error }}
    </article>
    {% endif %}

    <!-- Results Section -->
    {% if results|length > 0 %}
    <hr>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
        <h3 style="margin: 0;">Search Results <small>({{ total_results }} found)</small></h3>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="outline" onclick="selectAllResults(true)" style="font-size: 0.85rem;">Select All</button>
            <button class="outline secondary" onclick="selectAllResults(false)" style="font-size: 0.85rem;">Deselect All</button>
            <button id="btn-add-results" onclick="openAddToListModal()" disabled style="font-size: 0.85rem;">Add to List</button>
        </div>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" onchange="selectAllResults(this.checked)"></th>
                <th>#</th>
                <th>Name</th>
                <th>Title / Headline</th>
                <th>Company</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in results %}
            <tr>
                <td><input type="checkbox" class="result-cb" value="{{ loop.index0 }}" onchange="updateAddButton()"></td>
                <td>{{ loop.index }}</td>
                <td>
                    <a href="{{ lead.profile_url }}" target="_blank" rel="noopener">{{ lead.full_name }}</a>
                </td>
                <td>{{ lead.headline or '' }}</td>
                <td>{{ lead.company or '' }}</td>
                <td>{{ lead.location or '' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% elif search_query and not (error is defined and error) %}
    <article style="text-align: center; padding: 2rem; margin-top: 1rem;">
        <h3>No results found</h3>
        <p>Try different keywords or check if the sender is logged into LinkedIn.</p>
    </article>
    {% endif %}

    <!-- How to use -->
    <details style="margin-top: 2rem;">
        <summary><strong>How to use LinkedIn Search</strong></summary>
        <div style="padding: 1rem; font-size: 0.9rem;">
            <ol>
                <li><strong>Open a sender's browser</strong> — Go to Senders page and click "Open Chrome & Login"</li>
                <li><strong>Make sure they're logged in</strong> — Verify login on Senders page</li>
                <li><strong>Come here and search</strong> — Enter keywords and filters</li>
                <li><strong>Select results</strong> — Use checkboxes to select people</li>
                <li><strong>Add to List</strong> — Add selected results to a new or existing list</li>
                <li><strong>Create Campaign</strong> — Go to Lists, select your list, start a campaign</li>
            </ol>
            <p><strong>Search tips:</strong></p>
            <ul>
                <li>Job title: "Senior Software Engineer"</li>
                <li>Location: Use the Location field for better filtering</li>
                <li>Company + role: "Data Scientist Flipkart"</li>
                <li>Industry: "CEO SaaS startup"</li>
                <li>Max 999 results per search (LinkedIn limit)</li>
            </ul>
            <p><strong>Filters:</strong></p>
            <ul>
                <li><strong>Location</strong> — Type city/country name (e.g. "Mumbai", "India")</li>
                <li><strong>Network</strong> — 1st degree (connected), 2nd degree, 3rd+</li>
                <li><strong>Company Size</strong> — Filter by employer company size</li>
            </ul>
        </div>
    </details>
</section>

<!-- Add to List Modal -->
<div class="modal-overlay" id="add-to-list-modal">
    <div class="modal-content" style="max-width: 420px;">
        <header>
            <h3>Add Search Results to List</h3>
            <button class="outline secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="closeModal('add-to-list-modal')" type="button">&times;</button>
        </header>
        <div id="atl-form-section">
            <p id="atl-count" style="font-size: 0.9rem; margin-bottom: 1rem;"></p>
            <label>Existing List
                <select id="atl-list-name">
                    <option value="">-- Select list --</option>
                    {% for lst in lists %}
                    <option value="{{ lst.name }}">{{ lst.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>Or create new list
                <input type="text" id="atl-new-list" placeholder="e.g. Q1 Outreach Leads">
            </label>
            <fieldset class="grid">
                <button type="button" onclick="submitAddToList()">Add to List</button>
                <button type="button" class="secondary" onclick="closeModal('add-to-list-modal')">Cancel</button>
            </fieldset>
        </div>
        <div id="atl-result-section" style="display: none; text-align: center; padding: 1rem;">
            <p id="atl-result-msg"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Location Autocomplete ---
var geoTimer = null;
var geoCache = {};

function geoLookup(query) {
    clearTimeout(geoTimer);
    var dropdown = document.getElementById('geo-dropdown');
    if (!query || query.length < 2) {
        dropdown.style.display = 'none';
        return;
    }
    // Debounce 300ms
    geoTimer = setTimeout(function() { _doGeoLookup(query); }, 300);
}

function _doGeoLookup(query) {
    // Check cache
    if (geoCache[query]) {
        _renderGeoDropdown(geoCache[query]);
        return;
    }

    // Get a sender_id from the sender dropdown
    var senderSel = document.querySelector('select[name="sender_id"]');
    var senderId = senderSel ? senderSel.value : '';

    fetch('/search/geo-lookup?q=' + encodeURIComponent(query) + '&sender_id=' + senderId)
    .then(function(r) { return r.json(); })
    .then(function(results) {
        geoCache[query] = results;
        _renderGeoDropdown(results);
    })
    .catch(function() {
        document.getElementById('geo-dropdown').style.display = 'none';
    });
}

function _renderGeoDropdown(results) {
    var dropdown = document.getElementById('geo-dropdown');
    dropdown.innerHTML = '';

    if (!results || results.length === 0) {
        dropdown.style.display = 'none';
        return;
    }

    results.forEach(function(item) {
        var div = document.createElement('div');
        div.textContent = item.name;
        div.style.cssText = 'padding:0.6rem 0.8rem; cursor:pointer; font-size:0.9rem; border-bottom:1px solid var(--pico-muted-border-color);';
        div.onmouseenter = function() { div.style.background = 'var(--pico-primary-focus)'; };
        div.onmouseleave = function() { div.style.background = 'transparent'; };
        div.onclick = function() {
            document.getElementById('location-input').value = item.name;
            document.getElementById('location-text').value = item.name;
            document.getElementById('geo-urn-input').value = item.geoUrn;
            dropdown.style.display = 'none';
        };
        dropdown.appendChild(div);
    });

    dropdown.style.display = 'block';
}

// Close dropdown on outside click
document.addEventListener('click', function(e) {
    var dropdown = document.getElementById('geo-dropdown');
    var input = document.getElementById('location-input');
    if (dropdown && !dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
    }
});

// Clear geoUrn if user manually edits the text after selecting
document.getElementById('location-input').addEventListener('input', function() {
    document.getElementById('geo-urn-input').value = '';
    document.getElementById('location-text').value = this.value;
});

// Show loading state when searching
document.getElementById('search-form').addEventListener('submit', function() {
    var btn = document.getElementById('search-btn');
    btn.setAttribute('aria-busy', 'true');
    btn.textContent = 'Searching LinkedIn...';
    btn.disabled = true;
});

function selectAllResults(checked) {
    document.querySelectorAll('.result-cb').forEach(cb => cb.checked = checked);
    updateAddButton();
}

function getSelectedIndices() {
    return Array.from(document.querySelectorAll('.result-cb:checked')).map(cb => cb.value);
}

function updateAddButton() {
    var count = getSelectedIndices().length;
    var btn = document.getElementById('btn-add-results');
    if (btn) {
        btn.disabled = count === 0;
        btn.textContent = count > 0 ? 'Add ' + count + ' to List' : 'Add to List';
    }
}

function openAddToListModal() {
    var indices = getSelectedIndices();
    if (!indices.length) return;
    document.getElementById('atl-count').textContent = indices.length + ' people selected';
    document.getElementById('atl-form-section').style.display = 'block';
    document.getElementById('atl-result-section').style.display = 'none';
    openModal('add-to-list-modal');
}

function submitAddToList() {
    var indices = getSelectedIndices();
    var listName = document.getElementById('atl-list-name').value;
    var newListName = document.getElementById('atl-new-list').value;

    if (!listName && !newListName) {
        alert('Please select a list or create a new one.');
        return;
    }

    document.getElementById('atl-form-section').style.display = 'none';
    document.getElementById('atl-result-section').style.display = 'block';
    document.getElementById('atl-result-msg').setAttribute('aria-busy', 'true');
    document.getElementById('atl-result-msg').textContent = 'Adding leads to list...';

    var formData = new FormData();
    formData.append('list_name', listName);
    formData.append('new_list_name', newListName);
    formData.append('selected_indices', indices.join(','));

    fetch('/search/add-to-list', { method: 'POST', body: formData })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        document.getElementById('atl-result-msg').removeAttribute('aria-busy');
        if (data.success) {
            document.getElementById('atl-result-msg').innerHTML =
                '<strong>Done!</strong> Added ' + data.added + ' leads to "' + data.list_name + '"' +
                '<br><br><a href="/leads" role="button" class="outline">View Leads</a> ' +
                '<a href="/lists" role="button" class="outline secondary">View Lists</a>';
        } else {
            document.getElementById('atl-result-msg').innerHTML = '<strong style="color: var(--lp-red);">Failed</strong>';
        }
    })
    .catch(function() {
        document.getElementById('atl-result-msg').removeAttribute('aria-busy');
        document.getElementById('atl-result-msg').innerHTML = '<strong style="color: var(--lp-red);">Network error</strong>';
    });
}
</script>
{% endblock %}
