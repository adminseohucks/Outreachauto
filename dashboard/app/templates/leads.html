{% extends "base.html" %}
{% block title %}Lead Browser â€” LinkedPilot v2{% endblock %}

{% block content %}
<section>
    <h2>Lead Browser <small>({{ total }} leads)</small></h2>

    <!-- Filter bar -->
    <form method="get" action="/leads" class="filter-bar">
        <div class="filter-group">
            <label for="filter-title">Title</label>
            <input type="text" id="filter-title" name="title" placeholder="e.g. Engineer" value="{{ filters.title or '' }}">
        </div>
        <div class="filter-group">
            <label for="filter-company">Company</label>
            <input type="text" id="filter-company" name="company" placeholder="e.g. Infosys" value="{{ filters.company or '' }}">
        </div>
        <div class="filter-group">
            <label for="filter-location">Location</label>
            <input type="text" id="filter-location" name="location" placeholder="e.g. Bengaluru" value="{{ filters.location or '' }}">
        </div>
        <div class="filter-group">
            <label for="filter-status">Status</label>
            <select id="filter-status" name="status">
                <option value="">All</option>
                <option value="discovered" {% if filters.status == 'discovered' %}selected{% endif %}>Discovered</option>
                <option value="enriched" {% if filters.status == 'enriched' %}selected{% endif %}>Enriched</option>
                <option value="qualified" {% if filters.status == 'qualified' %}selected{% endif %}>Qualified</option>
                <option value="connected" {% if filters.status == 'connected' %}selected{% endif %}>Connected</option>
                <option value="replied" {% if filters.status == 'replied' %}selected{% endif %}>Replied</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filter-date-from">Date From</label>
            <input type="date" id="filter-date-from" name="date_from" value="{{ filters.date_from or '' }}">
        </div>
        <div class="filter-group">
            <label for="filter-date-to">Date To</label>
            <input type="date" id="filter-date-to" name="date_to" value="{{ filters.date_to or '' }}">
        </div>
        <div class="filter-group">
            <label for="filter-search">Search</label>
            <input type="text" id="filter-search" name="search" placeholder="Search..." value="{{ filters.search or '' }}">
        </div>
        <div class="filter-group" style="flex-direction: row; gap: 0.5rem;">
            <button type="submit">Filter</button>
            <a href="/leads" role="button" class="secondary outline">Clear</a>
        </div>
    </form>

    <!-- Action bar -->
    <div style="display: flex; gap: 1rem; align-items: end; margin-bottom: 1rem; flex-wrap: wrap;">
        <form method="post" action="/leads/export-csv" style="margin: 0;">
            <input type="hidden" name="title" value="{{ filters.title or '' }}">
            <input type="hidden" name="company" value="{{ filters.company or '' }}">
            <input type="hidden" name="location" value="{{ filters.location or '' }}">
            <input type="hidden" name="status" value="{{ filters.status or '' }}">
            <input type="hidden" name="date_from" value="{{ filters.date_from or '' }}">
            <input type="hidden" name="date_to" value="{{ filters.date_to or '' }}">
            <input type="hidden" name="search" value="{{ filters.search or '' }}">
            <button type="submit" class="secondary">Export CSV</button>
        </form>

        <form method="post" action="/leads/add-to-list" id="add-to-list-form" style="display: flex; gap: 0.5rem; align-items: end; margin: 0;">
            <input type="hidden" name="lead_ids" id="selected-lead-ids" value="">
            <div class="filter-group">
                <label for="list-select">Add to List</label>
                <select id="list-select" name="list_name" required>
                    <option value="">Select list...</option>
                    {% for lst in lists|default([]) %}
                    <option value="{{ lst.name }}">{{ lst.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" onclick="document.getElementById('selected-lead-ids').value = Array.from(document.querySelectorAll('input[name=lead_ids]:checked')).map(cb => cb.value).join(',');">Add</button>
        </form>
    </div>

    <!-- Leads table -->
    <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" onchange="toggleSelectAll(this)"></th>
                <th>Name</th>
                <th>Title</th>
                <th>Company</th>
                <th>Location</th>
                <th>Status</th>
                <th>Date Added</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td><input type="checkbox" name="lead_ids" value="{{ lead.id }}"></td>
                <td>
                    {% if lead.profile_url %}
                    <a href="{{ lead.profile_url }}" target="_blank" rel="noopener">{{ lead.full_name }}</a>
                    {% else %}
                    {{ lead.full_name }}
                    {% endif %}
                </td>
                <td>{{ lead.headline or '' }}</td>
                <td>{{ lead.company or '' }}</td>
                <td>{{ lead.location or '' }}</td>
                <td><span class="badge badge-{{ lead.status }}">{{ lead.status }}</span></td>
                <td>{{ lead.created_at[:10] if lead.created_at else '' }}</td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center;">No leads found matching your filters.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    {% set total_pages = pages|default(total_pages|default(1)) %}
    {% if total_pages > 1 %}
    <nav class="pagination">
        {% if page > 1 %}
        <a href="/leads?page={{ page - 1 }}&title={{ filters.title or '' }}&company={{ filters.company or '' }}&location={{ filters.location or '' }}&status={{ filters.status or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}&search={{ filters.search or '' }}">Previous</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <a href="#" class="current">{{ p }}</a>
            {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <a href="/leads?page={{ p }}&title={{ filters.title or '' }}&company={{ filters.company or '' }}&location={{ filters.location or '' }}&status={{ filters.status or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}&search={{ filters.search or '' }}">{{ p }}</a>
            {% elif p == 4 and page > 5 %}
            <span>...</span>
            {% elif p == total_pages - 2 and page < total_pages - 4 %}
            <span>...</span>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <a href="/leads?page={{ page + 1 }}&title={{ filters.title or '' }}&company={{ filters.company or '' }}&location={{ filters.location or '' }}&status={{ filters.status or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}&search={{ filters.search or '' }}">Next</a>
        {% endif %}
    </nav>
    {% endif %}
</section>
{% endblock %}
