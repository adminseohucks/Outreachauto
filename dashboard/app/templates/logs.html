{% extends "base.html" %}
{% block title %}Activity Log — LinkedPilot v2{% endblock %}

{% block content %}
<hgroup>
    <h2>Activity Log <small>({{ total }} entries)</small></h2>
    <p>Browse and filter all automation actions</p>
</hgroup>

<!-- Filter bar -->
<form method="get" action="/logs" class="filter-bar">
    <div class="filter-group">
        <label for="filter-action-type">Action Type</label>
        <select id="filter-action-type" name="action_type">
            <option value="">All</option>
            {% for at in action_types %}
            <option value="{{ at }}" {% if filters.action_type == at %}selected{% endif %}>{{ at }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-status">Status</label>
        <select id="filter-status" name="status">
            <option value="">All</option>
            {% for st in statuses %}
            <option value="{{ st }}" {% if filters.status == st %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-sender">Sender</label>
        <select id="filter-sender" name="sender_id">
            <option value="">All</option>
            {% for sender in senders %}
            <option value="{{ sender.id }}" {% if filters.sender_id | string == sender.id | string %}selected{% endif %}>{{ sender.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="filter-group">
        <label for="filter-date-from">Date From</label>
        <input type="date" id="filter-date-from" name="date_from" value="{{ filters.date_from or '' }}">
    </div>
    <div class="filter-group">
        <label for="filter-date-to">Date To</label>
        <input type="date" id="filter-date-to" name="date_to" value="{{ filters.date_to or '' }}">
    </div>
    <div class="filter-group" style="flex-direction: row; gap: 0.5rem;">
        <button type="submit">Filter</button>
        <a href="/logs" role="button" class="secondary outline">Clear</a>
    </div>
</form>

<!-- Export -->
<div style="margin-bottom: 1rem;">
    <form method="post" action="/logs/export" style="display: inline;">
        <input type="hidden" name="action_type" value="{{ filters.action_type or '' }}">
        <input type="hidden" name="status" value="{{ filters.status or '' }}">
        <input type="hidden" name="sender_id" value="{{ filters.sender_id or '' }}">
        <input type="hidden" name="date_from" value="{{ filters.date_from or '' }}">
        <input type="hidden" name="date_to" value="{{ filters.date_to or '' }}">
        <button type="submit" class="secondary outline">Export CSV</button>
    </form>
</div>

<!-- Log table -->
{% if logs %}
<figure>
    <table class="data-table" role="grid">
        <thead>
            <tr>
                <th>Time</th>
                <th>Sender</th>
                <th>Action Type</th>
                <th>Lead</th>
                <th>Status</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for log in logs %}
            <tr>
                <td><small>{{ log.created_at[:16] | replace('T', ' ') if log.created_at else '—' }}</small></td>
                <td>{{ log.sender_name or '—' }}</td>
                <td><span class="badge badge-{{ 'blue' if log.action_type == 'like' else 'orange' }}">{{ log.action_type }}</span></td>
                <td>
                    {% if log.lead_url %}
                    <a href="{{ log.lead_url }}" target="_blank" rel="noopener">{{ log.lead_name or 'View' }}</a>
                    {% else %}
                    {{ log.lead_name or '—' }}
                    {% endif %}
                </td>
                <td><span class="badge badge-{{ log.status }}">{{ log.status }}</span></td>
                <td><small>{{ log.details or '—' }}</small></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</figure>
{% else %}
<article>
    <p>No log entries found matching your filters.</p>
</article>
{% endif %}

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="pagination">
    {% if page > 1 %}
    <a href="/logs?page={{ page - 1 }}&action_type={{ filters.action_type or '' }}&status={{ filters.status or '' }}&sender_id={{ filters.sender_id or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}">Previous</a>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <a href="#" class="current">{{ p }}</a>
        {% elif p <= 3 or p > total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
        <a href="/logs?page={{ p }}&action_type={{ filters.action_type or '' }}&status={{ filters.status or '' }}&sender_id={{ filters.sender_id or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}">{{ p }}</a>
        {% elif p == 4 and page > 5 %}
        <span>...</span>
        {% elif p == total_pages - 2 and page < total_pages - 4 %}
        <span>...</span>
        {% endif %}
    {% endfor %}

    {% if page < total_pages %}
    <a href="/logs?page={{ page + 1 }}&action_type={{ filters.action_type or '' }}&status={{ filters.status or '' }}&sender_id={{ filters.sender_id or '' }}&date_from={{ filters.date_from or '' }}&date_to={{ filters.date_to or '' }}">Next</a>
    {% endif %}
</nav>
{% endif %}
{% endblock %}
