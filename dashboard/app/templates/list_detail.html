{% extends "base.html" %}
{% set list_info = list_info if list_info is defined else list %}
{% block title %}{{ list_info.name }} — LinkedPilot v2{% endblock %}

{% block content %}
<section>
    <hgroup>
        <h2>{{ list_info.name }} <small>({{ leads|length }} leads)</small></h2>
        {% if list_info.description %}
        <p>{{ list_info.description }}</p>
        {% endif %}
    </hgroup>

    <!-- Action buttons -->
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
        <button onclick="openModal('upload-csv-modal')">Upload CSV</button>
        <button class="secondary" onclick="openModal('campaign-modal'); document.getElementById('campaign-type-like').checked = true;">Start Like Campaign</button>
        <button class="secondary" onclick="openModal('campaign-modal'); document.getElementById('campaign-type-comment').checked = true;">Start Comment Campaign</button>
        <button class="outline" id="btn-delete-leads" onclick="deleteSelectedLeads()" disabled style="color: var(--lp-red, #e53e3e); border-color: var(--lp-red, #e53e3e);">Delete Selected</button>
        <a href="/lists" role="button" class="outline secondary">Back to Lists</a>
    </div>

    <!-- Leads table -->
    <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" onchange="document.querySelectorAll('.ld-cb').forEach(c=>c.checked=this.checked); updateDelBtn();"></th>
                <th>Name</th>
                <th>Headline</th>
                <th>Company</th>
                <th>Location</th>
                <th>Liked</th>
                <th>Commented</th>
                <th>Last Action</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td><input type="checkbox" class="ld-cb" value="{{ lead.id }}" onchange="updateDelBtn()"></td>
                <td>
                    {% if lead.profile_url %}
                    <a href="{{ lead.profile_url }}" target="_blank" rel="noopener">{{ lead.full_name }}</a>
                    {% else %}
                    {{ lead.full_name }}
                    {% endif %}
                </td>
                <td>{{ lead.headline or '' }}</td>
                <td>{{ lead.company or '' }}</td>
                <td>{{ lead.location or '' }}</td>
                <td>{% if lead.is_liked %}<span style="color: var(--lp-green);">&#10003;</span>{% else %}&mdash;{% endif %}</td>
                <td>{% if lead.is_commented %}<span style="color: var(--lp-green);">&#10003;</span>{% else %}&mdash;{% endif %}</td>
                <td>{{ lead.last_action_at[:16]|replace('T', ' ') if lead.last_action_at else '&mdash;' }}</td>
                <td>
                    <form method="post" action="/lists/{{ list_info.id }}/leads/{{ lead.id }}/delete" style="margin:0; display: inline;" onsubmit="return confirm('Delete this lead?')">
                        <button type="submit" class="outline" style="font-size: 0.65rem; padding: 0.15rem 0.4rem; color: var(--lp-red, #e53e3e); border-color: var(--lp-red, #e53e3e);">Remove</button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" style="text-align: center;">No leads in this list. Upload a CSV, search LinkedIn, or add leads manually.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>

<!-- CSV Upload Modal — Two-step with header matching -->
<div class="modal-overlay" id="upload-csv-modal">
    <div class="modal-content" style="max-width: 620px;">
        <header>
            <h3 id="csv-modal-title">Upload CSV</h3>
            <button class="outline secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="csvUploadReset()" type="button">&times;</button>
        </header>

        <!-- Step 1: File selection -->
        <div id="csv-step-1">
            <label for="csv-file">Select CSV File</label>
            <input type="file" id="csv-file" accept=".csv" onchange="csvFileSelected(this)">
            <small>Upload a CSV with your lead data. You will map columns in the next step.</small>
        </div>

        <!-- Step 2: Header matching -->
        <div id="csv-step-2" style="display: none;">
            <p style="margin-bottom: 0.5rem;"><strong id="csv-file-info"></strong></p>
            <small style="display: block; margin-bottom: 1rem;">Match your CSV columns to the database fields. <span style="color: var(--lp-accent);">profile_url is required.</span></small>

            <table class="data-table" style="font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th>Your CSV Column</th>
                        <th>Map To Database Field</th>
                    </tr>
                </thead>
                <tbody id="csv-mapping-body">
                    <!-- Populated by JavaScript -->
                </tbody>
            </table>

            <div id="csv-mapping-error" style="color: var(--lp-red, #e53e3e); font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>

            <footer style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="secondary outline" onclick="csvUploadReset()">Cancel</button>
                <button type="button" id="csv-upload-btn" onclick="csvSubmitMapped({{ list_info.id }})">
                    Upload &amp; Import
                </button>
            </footer>
        </div>

        <!-- Step 3: Progress / Result -->
        <div id="csv-step-3" style="display: none; text-align: center; padding: 1rem 0;">
            <p id="csv-progress-msg" aria-busy="true">Uploading and importing leads...</p>
        </div>
    </div>
</div>

<!-- Campaign Start Modal -->
<div class="modal-overlay" id="campaign-modal">
    <div class="modal-content">
        <header>
            <h3>Start Campaign</h3>
            <button class="outline secondary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;" onclick="closeModal('campaign-modal')" type="button">&times;</button>
        </header>
        <form method="post" action="/campaigns/create">
            <input type="hidden" name="list_id" value="{{ list_info.id }}">

            <label for="campaign-name">Campaign Name</label>
            <input type="text" id="campaign-name" name="name" placeholder="e.g. Like — {{ list_info.name }}" required>

            <label for="campaign-sender">Sender</label>
            <select id="campaign-sender" name="sender_id" required>
                <option value="">Select sender...</option>
                {% for sender in senders|default([]) %}
                <option value="{{ sender.id }}">{{ sender.name }}</option>
                {% endfor %}
            </select>

            <label for="campaign-act-as">Act As</label>
            <select id="campaign-act-as" name="company_page_id">
                <option value="0">Personal Profile (default)</option>
                {% for pg in company_pages|default([]) %}
                <option value="{{ pg.id }}">{{ pg.sender_name }} → {{ pg.page_name }}</option>
                {% endfor %}
            </select>
            <small>Select a company page to like/comment as that page.</small>

            <fieldset>
                <legend>Campaign Type</legend>
                <label>
                    <input type="radio" id="campaign-type-like" name="campaign_type" value="like" checked>
                    Like
                </label>
                <label>
                    <input type="radio" id="campaign-type-comment" name="campaign_type" value="comment">
                    Comment
                </label>
            </fieldset>

            <footer style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                <button type="button" class="secondary outline" onclick="closeModal('campaign-modal')">Cancel</button>
                <button type="submit">Create Campaign</button>
            </footer>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateDelBtn() {
    const count = document.querySelectorAll('.ld-cb:checked').length;
    document.getElementById('btn-delete-leads').disabled = count === 0;
}

function deleteSelectedLeads() {
    const ids = Array.from(document.querySelectorAll('.ld-cb:checked')).map(c => c.value);
    if (!ids.length) return;
    if (!confirm('Delete ' + ids.length + ' lead(s)? This cannot be undone.')) return;

    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/leads/delete';
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'lead_ids';
    input.value = ids.join(',');
    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
